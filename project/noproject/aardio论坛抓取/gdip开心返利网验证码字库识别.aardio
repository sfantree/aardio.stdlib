import win.ui;
/*DSG{{*/
var winform = ..win.form( right=488;max=false;bottom=338;text="开心返利网验证码识别";border="dialog frame" )
winform.add( 
picturebox={ bottom=233;right=435;left=53;top=39;center=1;z=2;edge=1;cls="picturebox" };
edit={ bottom=295;right=434;left=53;multiline=1;top=260;z=1;edge=1;cls="edit" }
)
/*}}*/

字库 = {
        ["111111000011000110001100011000110000111111"]="z";
        ["00111100011001101100001101100110001111000110011011000011110000110110011000111100"]="8";
        ["11000011110000110110011001100110001111000011110000011000"]="v";
        ["01111110110000111100000001111110000000111100001101111110"]="s";
        ["001100000011000011111100001100000011000000110000001100000011001100011110"]="t";
        ["11011100111001101100001111000011110000111100001111000011"]="n";
        ["00111100011001101100001011000000110111001110011011000011110000110110011000111100"]="6";
        ["11111111000000110000001100000110000011000001100000110000011000001100000011000000"]="7";
        ["00111100011001101100001111000011110000110110011000111100"]="o";
        ["001100001100000000011100001100001100001100001100001100111111"]="i";
        ["11000011011001100011110000011000001111000110011011000011"]="x";
        ["110111001110011011000011110000111100001111100110110111001100000011000000"]="p";
        ["001100011100111100001100001100001100001100001100001100111111"]="1";
        ["00111110011000110000001101111111110000111100011101111011"]="a";
        ["11111110110000001100000011011100111001100000001100000011110000110110011000111100"]="5";
        ["00111100011001101100001111000011011001110011101100000011010000110110011000111100"]="9";
        ["000001100000110000000000011100000110000011000001100000110000011110001111000110111110"]="j";
        ["11000011110000111100001111000011110000110110011100111011"]="u";
        ["10110110110110111101101111011011110110111101101111011011"]="m";
        ["00111100011001101100001111111111110000000110001100111110"]="e";
        ["110000111100001111000011110000111100001101100111001110111000001101111110"]="y";
        ["00011110001100110011001100110000001100001111110000110000001100000011000000110000"]="f";
        ["11000000110000001100000011011100111001101100001111000011110000111100001111000011"]="h";
        ["00111100011001101100001100000011000001100000110000011000001100000110000011111111"]="2";
        ["011111011100011111000110110001100111110011000000011111101100001101111110"]="g";
        ["00000011000000110000001100111011011001111100001111000011110000110110011100111011"]="d";
        ["00000110000011100001111000110110011001101100011011111111000001100000011000000110"]="4";
        ["11000011110000111101101111011011110110111111111101100110"]="w";
        ["00111110011000111100000011000000110000000110001100111110"]="c";
        ["1110011001100110011001100110011001101111"]="l";
        ["01111100110001100000001100000110000111000000011000000011000000111100011001111100"]="3";
        ["001110110110011111000011110000111100001101100111001110110000001100000011"]="q";
        ["11011110011100110110000001100000011000000110000001100000"]="r";
        ["1100000110000011000001100110110110011110001111000110110011001101100011"]="k";
        ["11000000110000001100000011011100111001101100001111000011110000111110011011011100"]="b"
}

import gdip;
import inet.whttp;
var http=inet.whttp();

var bmp=gdip.bitmap(http.get("http://www.199001.com/imgcode"));
winform.picturebox.setImage(bmp.copyHandle());

提取特征码 = function(x0,y0,x9,y9){
    var 黑色=0xff000000;
        var bmpData=bmp.lockData32();
        var bits=bmpData.bits.rows;
        
    //找左边
    var l=0;
    for(x=x0;x9;1){
        for(y=y0;y9;1){
            if(bits[y].pixels[x]==黑色){
                l=x;
                break 2;
            }
        }
    }
        //找右边
        var r=0;
        for(x=x9;x0;-1){
                var tab={};
                for(y=y0;y9;1){
                        if(bits[y].pixels[x]==黑色){
                                r=x;
                                break 2;
                        }
                }
        }        
        //找上边
        var t=0;
        for(y=y0;y9;1){
                for(x=x0;x9;1){
                        if(bits[y].pixels[x]==黑色){
                                t=y;
                                break 2;
                        }
                }
        }
        //找下边
        var b=0;
        for(y=y9;y0;-1){
                for(x=x0;x9;1){
                        if(bits[y].pixels[x]==黑色){
                                b=y;
                                break 2;
                        }
                }
        }
        //生成 特征码
        var tab={};
        for(y=t;b;1){
                for(x=l;r;1){
                        if(bits[y].pixels[x]==黑色){
                                table.push(tab,1);
                        }
                        else{
                                table.push(tab,0);
                        }
                }
        }
        bmp.unlockData(bmpData);
        return string.join(tab); 
}

var str_1=提取特征码(0,5,20,20);
var str_2=提取特征码(20,5,40,20);
var str_3=提取特征码(40,5,60,20);
var str_4=提取特征码(60,5,80,20);

winform.edit.text = string.concat(字库[str_1],字库[str_2],字库[str_3],字库[str_4])

winform.show();
win.loopMessage();